# SPDX-License-Identifier: BSD-3-Clause
# Release workflow for automated tagging and releasing on PR merge
name: Release
permissions:
  contents: write
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Configure git
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
    - name: Increment version
      run: |
        last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.1.3")
        IFS='.' read -r major minor patch <<< "$last_tag"
        new_patch=$((patch + 1))
        new_version="${major}.${minor}.${new_patch}"
        echo "$new_version" > VERSION
        git add VERSION
        git commit -m "chore: bump version to ${new_version}"
        git push
        echo "VERSION=${new_version}" >> "$GITHUB_ENV"
        echo "TAG=${new_version}" >> "$GITHUB_ENV"
    - name: Push tag
      run: |
        git tag ${{ env.TAG }}
        git push origin ${{ env.TAG }}
    - name: Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG }}
        release_name: ${{ github.event.pull_request.title }}
        body: ${{ github.event.pull_request.body }}
        draft: false
        prerelease: false